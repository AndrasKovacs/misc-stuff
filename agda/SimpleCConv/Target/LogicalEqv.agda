
module Target.LogicalEqv where

open import Lib
open import Target.Syntax

infix 4 _â‰ˆ_
_â‰ˆ_ : âˆ€ {A} â†’ Tm âˆ™ A â†’ Tm âˆ™ A â†’ Set
_â‰ˆ_ {ğ”¹}      t u = ((t ~ true) Ã— (u ~ true)) âŠ ((t ~ false) Ã— (u ~ false))
_â‰ˆ_ {Top}    t u = âŠ¤
_â‰ˆ_ {A * B}  t u = (Ï€â‚ t â‰ˆ Ï€â‚ u) Ã— (Ï€â‚‚ t â‰ˆ Ï€â‚‚ u)
_â‰ˆ_ {A â‡’âº B} t u = âˆ€ {a a'} â†’ a â‰ˆ a' â†’ appâº t a â‰ˆ appâº u a'
_â‰ˆ_ {A â‡’ B}  t u = âˆ€ {a a'} â†’ a â‰ˆ a' â†’ app t a â‰ˆ app u a'

infix 6 _â‰ˆâ»Â¹
_â‰ˆâ»Â¹ : âˆ€ {A}{t t' : Tm âˆ™ A} â†’ t â‰ˆ t' â†’ t' â‰ˆ t
_â‰ˆâ»Â¹ {ğ”¹} (inl (p , q)) = inl (q , p)
_â‰ˆâ»Â¹ {ğ”¹} (inr (p , q)) = inr (q , p)
_â‰ˆâ»Â¹ {Top}    p       = p
_â‰ˆâ»Â¹ {A * B}  (p , q) = (p â‰ˆâ»Â¹) , (q â‰ˆâ»Â¹)
_â‰ˆâ»Â¹ {A â‡’ B}  p       = Î» q â†’ p (q â‰ˆâ»Â¹) â‰ˆâ»Â¹
_â‰ˆâ»Â¹ {A â‡’âº B} p       = Î» q â†’ p (q â‰ˆâ»Â¹) â‰ˆâ»Â¹

infixr 4 _â‰ˆâ—¾_
_â‰ˆâ—¾_ : âˆ€ {A}{t t' t'' : Tm âˆ™ A} â†’ t â‰ˆ t' â†’ t' â‰ˆ t'' â†’ t â‰ˆ t''
_â‰ˆâ—¾_ {ğ”¹} (inl (p , q)) (inl (r , s)) = inl (p , s)
_â‰ˆâ—¾_ {ğ”¹} (inl (p , q)) (inr (r , s)) = inl (p , (s ~â—¾ r ~â»Â¹ ~â—¾ q))
_â‰ˆâ—¾_ {ğ”¹} (inr (p , q)) (inl (r , s)) = inl ((p ~â—¾ q ~â»Â¹ ~â—¾ r) , s)
_â‰ˆâ—¾_ {ğ”¹} (inr (p , q)) (inr (r , s)) = inr (p , s)
_â‰ˆâ—¾_ {A â‡’ B} p q = Î» r â†’ p r â‰ˆâ—¾ q (r â‰ˆâ»Â¹ â‰ˆâ—¾ r)
_â‰ˆâ—¾_ {A â‡’âº B} p q = Î» r â†’ p r â‰ˆâ—¾ q (r â‰ˆâ»Â¹ â‰ˆâ—¾ r)
_â‰ˆâ—¾_ {Top} p q = p
_â‰ˆâ—¾_ {A * B} (p , q) (r , s) = (p â‰ˆâ—¾ r) , (q â‰ˆâ—¾ s)

infixr 4 _~â—¾â‰ˆ_
_~â—¾â‰ˆ_ : âˆ€ {A}{t t' t'' : Tm âˆ™ A} â†’ t ~ t' â†’ t' â‰ˆ t'' â†’ t â‰ˆ t''
_~â—¾â‰ˆ_ {ğ”¹} p (inl (q , r)) = inl ((p ~â—¾ q) , r)
_~â—¾â‰ˆ_ {ğ”¹} p (inr (q , r)) = inr ((p ~â—¾ q) , r)
_~â—¾â‰ˆ_ {Top}   p q = tt
_~â—¾â‰ˆ_ {A * B} p (q , r) = (Ï€â‚ p ~â—¾â‰ˆ q) , (Ï€â‚‚ p ~â—¾â‰ˆ r)
_~â—¾â‰ˆ_ {A â‡’ B} {t} {t'} {t''} p q {a} {a'} r = app p ~refl ~â—¾â‰ˆ q r
_~â—¾â‰ˆ_ {A â‡’âº B} {t} {t'} {t''} p q {a} {a'} r = appâº p ~refl ~â—¾â‰ˆ q r

infixl 5 _â‰ˆâ—¾~_
_â‰ˆâ—¾~_ : âˆ€ {A}{t t' t'' : Tm âˆ™ A} â†’ t â‰ˆ t' â†’ t' ~ t'' â†’ t â‰ˆ t''
p â‰ˆâ—¾~ q = (q ~â»Â¹ ~â—¾â‰ˆ p â‰ˆâ»Â¹) â‰ˆâ»Â¹

infix 4 _â‰ˆâ‚›_
_â‰ˆâ‚›_ : âˆ€ {Î“} â†’ Sub âˆ™ Î“ â†’ Sub âˆ™ Î“ â†’ Set
âˆ™       â‰ˆâ‚›  âˆ™       = âŠ¤
(Ïƒ , t) â‰ˆâ‚› (Î´ , t') = (Ïƒ â‰ˆâ‚› Î´) Ã— (t â‰ˆ t')

Tmâ‰ˆ : âˆ€ {Î“ A}(t : Tm Î“ A) (Ïƒ Ïƒ' : Sub âˆ™ Î“) â†’ Ïƒ â‰ˆâ‚› Ïƒ' â†’ Tmâ‚› Ïƒ t â‰ˆ Tmâ‚› Ïƒ' t
Tmâ‰ˆ (var vz)     (Ïƒ , _) (Ïƒ' , _) Ïƒâ‰ˆ = â‚‚ Ïƒâ‰ˆ
Tmâ‰ˆ (var (vs x)) (Ïƒ , _) (Ïƒ' , _) Ïƒâ‰ˆ = Tmâ‰ˆ (var x) Ïƒ Ïƒ' (â‚ Ïƒâ‰ˆ )
Tmâ‰ˆ tt         Ïƒ Ïƒ' Ïƒâ‰ˆ = tt
Tmâ‰ˆ true       Ïƒ Ïƒ' Ïƒâ‰ˆ = inl (~refl , ~refl)
Tmâ‰ˆ false      Ïƒ Ïƒ' Ïƒâ‰ˆ = inr (~refl , ~refl)
Tmâ‰ˆ (if t u v) Ïƒ Ïƒ' Ïƒâ‰ˆ with Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ
... | inl (p , q) =
  if p ~refl ~refl ~â—¾â‰ˆ true ~â—¾â‰ˆ Tmâ‰ˆ u Ïƒ Ïƒ' Ïƒâ‰ˆ â‰ˆâ—¾~ (if q ~refl ~refl ~â—¾ true) ~â»Â¹
... | inr (p , q) =
  if p ~refl ~refl ~â—¾â‰ˆ false ~â—¾â‰ˆ Tmâ‰ˆ v Ïƒ Ïƒ' Ïƒâ‰ˆ â‰ˆâ—¾~ (if q ~refl ~refl ~â—¾ false) ~â»Â¹
Tmâ‰ˆ (Ï€â‚ t)     Ïƒ Ïƒ' Ïƒâ‰ˆ = â‚ (Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ)
Tmâ‰ˆ (Ï€â‚‚ t)     Ïƒ Ïƒ' Ïƒâ‰ˆ = â‚‚ (Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ)
Tmâ‰ˆ (t , u)    Ïƒ Ïƒ' Ïƒâ‰ˆ = (Ï€â‚Î² _ _ ~â—¾â‰ˆ Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ â‰ˆâ—¾~ Ï€â‚Î² _ _ ~â»Â¹) ,
                         (Ï€â‚‚Î² _ _ ~â—¾â‰ˆ Tmâ‰ˆ u Ïƒ Ïƒ' Ïƒâ‰ˆ â‰ˆâ—¾~ Ï€â‚‚Î² _ _ ~â»Â¹)
Tmâ‰ˆ (app t u)  Ïƒ Ïƒ' Ïƒâ‰ˆ = Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ (Tmâ‰ˆ u Ïƒ Ïƒ' Ïƒâ‰ˆ)
Tmâ‰ˆ (appâº t u) Ïƒ Ïƒ' Ïƒâ‰ˆ = Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ (Tmâ‰ˆ u Ïƒ Ïƒ' Ïƒâ‰ˆ)
Tmâ‰ˆ (pack t u) Ïƒ Ïƒ' Ïƒâ‰ˆ {a}{a'} p =
      Î²á¶œ _ _ _
  ~â—¾â‰ˆ Tmâ‰ˆ u Ïƒ Ïƒ' Ïƒâ‰ˆ {Tmâ‚› Ïƒ t , a}{Tmâ‚› Ïƒ' t , a'}
              ((Ï€â‚Î² _ _ ~â—¾â‰ˆ Tmâ‰ˆ t Ïƒ Ïƒ' Ïƒâ‰ˆ â‰ˆâ—¾~ Ï€â‚Î² _ _ ~â»Â¹) ,
               (Ï€â‚‚Î² _ _ ~â—¾â‰ˆ p â‰ˆâ—¾~ Ï€â‚‚Î² _ _ ~â»Â¹))
  â‰ˆâ—¾~ Î²á¶œ _ _ _ ~â»Â¹
Tmâ‰ˆ (lam t)    Ïƒ Ïƒ' Ïƒâ‰ˆ {a}{a'} p =
      Î² _ _
  ~â—¾â‰ˆ Tmâ‰ˆ t (âˆ™ , a) (âˆ™ , a') (tt , p)
  â‰ˆâ—¾~ Î² _ _ ~â»Â¹


â‰ˆrefl : âˆ€ {A}{t : Tm âˆ™ A} â†’ t â‰ˆ t
â‰ˆrefl {A} {t} = coe (_â‰ˆ_ & Tm-idâ‚› t âŠ— Tm-idâ‚› t) (Tmâ‰ˆ t idâ‚› idâ‚› tt)

~â‰ˆ : âˆ€ {A}{t t' : Tm âˆ™ A} â†’ t ~ t' â†’ t â‰ˆ t'
~â‰ˆ p = p ~â—¾â‰ˆ â‰ˆrefl
