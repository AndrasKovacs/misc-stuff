{-# OPTIONS --without-K #-}

module Source.Syntax where

open import Lib

infixr 4 _â‡’_
infixr 4 _â–¶_

data Ty : Set where
  ğ”¹   : Ty
  _â‡’_ : Ty â†’ Ty â†’ Ty

data Con : Set where
  âˆ™   : Con
  _â–¶_ : Con â†’ Ty â†’ Con

data _âˆˆ_ (A : Ty) : Con â†’ Set where
  vz : âˆ€ {Î“} â†’ A âˆˆ (Î“ â–¶ A)
  vs : âˆ€ {B Î“} â†’ A âˆˆ Î“ â†’ A âˆˆ (Î“ â–¶ B)

data Tm Î“ : Ty â†’ Set where
  true false : Tm Î“ ğ”¹
  if   : âˆ€ {A} â†’ Tm Î“ ğ”¹ â†’ Tm Î“ A â†’ Tm Î“ A â†’ Tm Î“ A
  var  : âˆ€ {A} â†’ A âˆˆ Î“ â†’ Tm Î“ A
  lam  : âˆ€ {A B} â†’ Tm (Î“ â–¶ A) B â†’ Tm Î“ (A â‡’ B)
  app  : âˆ€ {A B} â†’ Tm Î“ (A â‡’ B) â†’ Tm Î“ A â†’ Tm Î“ B

-- Embedding
--------------------------------------------------------------------------------

-- Order-preserving embedding
data OPE : Con â†’ Con â†’ Set where
  âˆ™    : OPE âˆ™ âˆ™
  drop : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ OPE (Î“ â–¶ A) Î”
  keep : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ OPE (Î“ â–¶ A) (Î” â–¶ A)

-- OPE is a category
idâ‚‘ : âˆ€ {Î“} â†’ OPE Î“ Î“
idâ‚‘ {âˆ™}     = âˆ™
idâ‚‘ {Î“ â–¶ A} = keep (idâ‚‘ {Î“})

wk : âˆ€ {A Î“} â†’ OPE (Î“ â–¶ A) Î“
wk = drop idâ‚‘

_âˆ˜â‚‘_ : âˆ€ {Î“ Î” Î£} â†’ OPE Î” Î£ â†’ OPE Î“ Î” â†’ OPE Î“ Î£
Ïƒ      âˆ˜â‚‘ âˆ™      = Ïƒ
Ïƒ      âˆ˜â‚‘ drop Î´ = drop (Ïƒ âˆ˜â‚‘ Î´)
drop Ïƒ âˆ˜â‚‘ keep Î´ = drop (Ïƒ âˆ˜â‚‘ Î´)
keep Ïƒ âˆ˜â‚‘ keep Î´ = keep (Ïƒ âˆ˜â‚‘ Î´)

idlâ‚‘ : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ idâ‚‘ âˆ˜â‚‘ Ïƒ â‰¡ Ïƒ
idlâ‚‘ âˆ™        = refl
idlâ‚‘ (drop Ïƒ) = drop & idlâ‚‘ Ïƒ
idlâ‚‘ (keep Ïƒ) = keep & idlâ‚‘ Ïƒ

idrâ‚‘ : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ Ïƒ âˆ˜â‚‘ idâ‚‘ â‰¡ Ïƒ
idrâ‚‘ âˆ™        = refl
idrâ‚‘ (drop Ïƒ) = drop & idrâ‚‘ Ïƒ
idrâ‚‘ (keep Ïƒ) = keep & idrâ‚‘ Ïƒ

assâ‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : OPE Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ âˆ˜â‚‘ Î´) âˆ˜â‚‘ Î½ â‰¡ Ïƒ âˆ˜â‚‘ (Î´ âˆ˜â‚‘ Î½)
assâ‚‘ Ïƒ        Î´        âˆ™        = refl
assâ‚‘ Ïƒ        Î´        (drop Î½) = drop & assâ‚‘ Ïƒ Î´ Î½
assâ‚‘ Ïƒ        (drop Î´) (keep Î½) = drop & assâ‚‘ Ïƒ Î´ Î½
assâ‚‘ (drop Ïƒ) (keep Î´) (keep Î½) = drop & assâ‚‘ Ïƒ Î´ Î½
assâ‚‘ (keep Ïƒ) (keep Î´) (keep Î½) = keep & assâ‚‘ Ïƒ Î´ Î½

-- (A âˆˆ_) : PSh OPE
âˆˆâ‚‘ : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ A âˆˆ Î” â†’ A âˆˆ Î“
âˆˆâ‚‘ âˆ™        v      = v
âˆˆâ‚‘ (drop Ïƒ) v      = vs (âˆˆâ‚‘ Ïƒ v)
âˆˆâ‚‘ (keep Ïƒ) vz     = vz
âˆˆâ‚‘ (keep Ïƒ) (vs v) = vs (âˆˆâ‚‘ Ïƒ v)

âˆˆ-idâ‚‘ : âˆ€ {A Î“}(v : A âˆˆ Î“) â†’ âˆˆâ‚‘ idâ‚‘ v â‰¡ v
âˆˆ-idâ‚‘ vz     = refl
âˆˆ-idâ‚‘ (vs v) = vs & âˆˆ-idâ‚‘ v

âˆˆ-âˆ˜â‚‘ : âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(v : A âˆˆ Î£) â†’ âˆˆâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) v â‰¡ âˆˆâ‚‘ Î´ (âˆˆâ‚‘ Ïƒ v)
âˆˆ-âˆ˜â‚‘ âˆ™        âˆ™        v      = refl
âˆˆ-âˆ˜â‚‘ Ïƒ        (drop Î´) v      = vs & âˆˆ-âˆ˜â‚‘ Ïƒ Î´ v
âˆˆ-âˆ˜â‚‘ (drop Ïƒ) (keep Î´) v      = vs & âˆˆ-âˆ˜â‚‘ Ïƒ Î´ v
âˆˆ-âˆ˜â‚‘ (keep Ïƒ) (keep Î´) vz     = refl
âˆˆ-âˆ˜â‚‘ (keep Ïƒ) (keep Î´) (vs v) = vs & âˆˆ-âˆ˜â‚‘ Ïƒ Î´ v

-- (Tm _ A) : PSh OPE
Tmâ‚‘ : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ Tm Î” A â†’ Tm Î“ A
Tmâ‚‘ Ïƒ (if t u v) = if (Tmâ‚‘ Ïƒ t) (Tmâ‚‘ Ïƒ u) (Tmâ‚‘ Ïƒ v)
Tmâ‚‘ Ïƒ false      = false
Tmâ‚‘ Ïƒ true       = true
Tmâ‚‘ Ïƒ (var v)    = var (âˆˆâ‚‘ Ïƒ v)
Tmâ‚‘ Ïƒ (lam t)    = lam (Tmâ‚‘ (keep Ïƒ) t)
Tmâ‚‘ Ïƒ (app f a)  = app (Tmâ‚‘ Ïƒ f) (Tmâ‚‘ Ïƒ a)

Tm-idâ‚‘ : âˆ€ {A Î“}(t : Tm Î“ A) â†’ Tmâ‚‘ idâ‚‘ t â‰¡ t
Tm-idâ‚‘ (if t u v) = if & Tm-idâ‚‘ t âŠ— Tm-idâ‚‘ u âŠ— Tm-idâ‚‘ v
Tm-idâ‚‘ false      = refl
Tm-idâ‚‘ true       = refl
Tm-idâ‚‘ (var v)    = var & âˆˆ-idâ‚‘ v
Tm-idâ‚‘ (lam t)    = lam & Tm-idâ‚‘ t
Tm-idâ‚‘ (app f a)  = app & Tm-idâ‚‘ f âŠ— Tm-idâ‚‘ a

Tm-âˆ˜â‚‘ : âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) t â‰¡ Tmâ‚‘ Î´ (Tmâ‚‘ Ïƒ t)
Tm-âˆ˜â‚‘ Î£ Î´ (if t u v) = if & Tm-âˆ˜â‚‘ Î£ Î´ t âŠ— Tm-âˆ˜â‚‘ Î£ Î´ u âŠ— Tm-âˆ˜â‚‘ Î£ Î´ v
Tm-âˆ˜â‚‘ Î£ Î´ false      = refl
Tm-âˆ˜â‚‘ Î£ Î´ true       = refl
Tm-âˆ˜â‚‘ Ïƒ Î´ (var v)    = var & âˆˆ-âˆ˜â‚‘ Ïƒ Î´ v
Tm-âˆ˜â‚‘ Ïƒ Î´ (lam t)    = lam & Tm-âˆ˜â‚‘ (keep Ïƒ) (keep Î´) t
Tm-âˆ˜â‚‘ Ïƒ Î´ (app f a)  = app & Tm-âˆ˜â‚‘ Ïƒ Î´ f âŠ— Tm-âˆ˜â‚‘ Ïƒ Î´ a

-- Theory of substitution & embedding
--------------------------------------------------------------------------------

infixr 6 _â‚‘âˆ˜â‚›_ _â‚›âˆ˜â‚‘_ _âˆ˜â‚›_

data Sub (Î“ : Con) : Con â†’ Set where
  âˆ™   : Sub Î“ âˆ™
  _,_ : âˆ€ {A : Ty}{Î” : Con} â†’ Sub Î“ Î” â†’ Tm Î“ A â†’ Sub Î“ (Î” â–¶ A)

_â‚›âˆ˜â‚‘_ : âˆ€ {Î“ Î” Î£} â†’ Sub Î” Î£ â†’ OPE Î“ Î” â†’ Sub Î“ Î£
âˆ™       â‚›âˆ˜â‚‘ Î´ = âˆ™
(Ïƒ , t) â‚›âˆ˜â‚‘ Î´ = Ïƒ â‚›âˆ˜â‚‘ Î´ , Tmâ‚‘ Î´ t

_â‚‘âˆ˜â‚›_ : âˆ€ {Î“ Î” Î£} â†’ OPE Î” Î£ â†’ Sub Î“ Î” â†’ Sub Î“ Î£
âˆ™      â‚‘âˆ˜â‚› Î´       = Î´
drop Ïƒ â‚‘âˆ˜â‚› (Î´ , t) = Ïƒ â‚‘âˆ˜â‚› Î´
keep Ïƒ â‚‘âˆ˜â‚› (Î´ , t) = Ïƒ â‚‘âˆ˜â‚› Î´ , t

dropâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ Sub (Î“ â–¶ A) Î”
dropâ‚› Ïƒ = Ïƒ â‚›âˆ˜â‚‘ wk

keepâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ Sub (Î“ â–¶ A) (Î” â–¶ A)
keepâ‚› Ïƒ = dropâ‚› Ïƒ , var vz

âŒœ_âŒáµ’áµ–áµ‰ : âˆ€ {Î“ Î”} â†’ OPE Î“ Î” â†’ Sub Î“ Î”
âŒœ âˆ™      âŒáµ’áµ–áµ‰ = âˆ™
âŒœ drop Ïƒ âŒáµ’áµ–áµ‰ = dropâ‚› âŒœ Ïƒ âŒáµ’áµ–áµ‰
âŒœ keep Ïƒ âŒáµ’áµ–áµ‰ = keepâ‚› âŒœ Ïƒ âŒáµ’áµ–áµ‰

âˆˆâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ A âˆˆ Î” â†’ Tm Î“ A
âˆˆâ‚› (Ïƒ , t) vz     = t
âˆˆâ‚› (Ïƒ  , t)(vs v) = âˆˆâ‚› Ïƒ v

Tmâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ Tm Î” A â†’ Tm Î“ A
Tmâ‚› Ïƒ (if t u v) = if (Tmâ‚› Ïƒ t) (Tmâ‚› Ïƒ u) (Tmâ‚› Ïƒ v)
Tmâ‚› Ïƒ false      = false
Tmâ‚› Ïƒ true       = true
Tmâ‚› Ïƒ (var v)    = âˆˆâ‚› Ïƒ v
Tmâ‚› Ïƒ (lam t)    = lam (Tmâ‚› (keepâ‚› Ïƒ) t)
Tmâ‚› Ïƒ (app f a)  = app (Tmâ‚› Ïƒ f) (Tmâ‚› Ïƒ a)

idâ‚› : âˆ€ {Î“} â†’ Sub Î“ Î“
idâ‚› {âˆ™}     = âˆ™
idâ‚› {Î“ â–¶ A} = keepâ‚› idâ‚›

_âˆ˜â‚›_ : âˆ€ {Î“ Î” Î£} â†’ Sub Î” Î£ â†’ Sub Î“ Î” â†’ Sub Î“ Î£
âˆ™       âˆ˜â‚› Î´ = âˆ™
(Ïƒ , t) âˆ˜â‚› Î´ = Ïƒ âˆ˜â‚› Î´ , Tmâ‚› Î´ t

assâ‚›â‚‘â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : OPE Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ â‚›âˆ˜â‚‘ Î´) â‚›âˆ˜â‚‘ Î½ â‰¡ Ïƒ â‚›âˆ˜â‚‘ (Î´ âˆ˜â‚‘ Î½)
assâ‚›â‚‘â‚‘ âˆ™       Î´ Î½ = refl
assâ‚›â‚‘â‚‘ (Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚‘â‚‘ Ïƒ Î´ Î½ âŠ— (Tm-âˆ˜â‚‘ Î´ Î½ t â»Â¹)

assâ‚‘â‚›â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : Sub Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ â‚‘âˆ˜â‚› Î´) â‚›âˆ˜â‚‘ Î½ â‰¡ Ïƒ â‚‘âˆ˜â‚› (Î´ â‚›âˆ˜â‚‘ Î½)
assâ‚‘â‚›â‚‘ âˆ™        Î´       Î½ = refl
assâ‚‘â‚›â‚‘ (drop Ïƒ) (Î´ , t) Î½ = assâ‚‘â‚›â‚‘ Ïƒ Î´ Î½
assâ‚‘â‚›â‚‘ (keep Ïƒ) (Î´ , t) Î½ = (_, Tmâ‚‘ Î½ t) & assâ‚‘â‚›â‚‘ Ïƒ Î´ Î½

idlâ‚‘â‚› : âˆ€ {Î“ Î”}(Ïƒ : Sub Î“ Î”) â†’ idâ‚‘ â‚‘âˆ˜â‚› Ïƒ â‰¡ Ïƒ
idlâ‚‘â‚› âˆ™       = refl
idlâ‚‘â‚› (Ïƒ , t) = (_, t) & idlâ‚‘â‚› Ïƒ

idlâ‚›â‚‘ : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ idâ‚› â‚›âˆ˜â‚‘ Ïƒ â‰¡ âŒœ Ïƒ âŒáµ’áµ–áµ‰
idlâ‚›â‚‘ âˆ™        = refl
idlâ‚›â‚‘ (drop Ïƒ) =
      ((idâ‚› â‚›âˆ˜â‚‘_) âˆ˜ drop) & idrâ‚‘ Ïƒ â»Â¹
    â—¾ assâ‚›â‚‘â‚‘ idâ‚› Ïƒ wk â»Â¹
    â—¾ dropâ‚› & idlâ‚›â‚‘ Ïƒ
idlâ‚›â‚‘ (keep Ïƒ) =
  (_, var vz) &
      (assâ‚›â‚‘â‚‘ idâ‚› wk (keep Ïƒ)
    â—¾ ((idâ‚› â‚›âˆ˜â‚‘_) âˆ˜ drop) & (idlâ‚‘ Ïƒ â—¾ idrâ‚‘ Ïƒ â»Â¹)
    â—¾ assâ‚›â‚‘â‚‘ idâ‚› Ïƒ wk â»Â¹
    â—¾ (_â‚›âˆ˜â‚‘ wk) & idlâ‚›â‚‘ Ïƒ )

idrâ‚‘â‚› : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ Ïƒ â‚‘âˆ˜â‚› idâ‚› â‰¡ âŒœ Ïƒ âŒáµ’áµ–áµ‰
idrâ‚‘â‚› âˆ™        = refl
idrâ‚‘â‚› (drop Ïƒ) = assâ‚‘â‚›â‚‘ Ïƒ idâ‚› wk â»Â¹ â—¾ dropâ‚› & idrâ‚‘â‚› Ïƒ
idrâ‚‘â‚› (keep Ïƒ) = (_, var vz) & (assâ‚‘â‚›â‚‘ Ïƒ idâ‚› wk â»Â¹ â—¾ (_â‚›âˆ˜â‚‘ wk) & idrâ‚‘â‚› Ïƒ)

âˆˆ-â‚‘âˆ˜â‚› : âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î£)(Î´ : Sub Î“ Î”)(v : A âˆˆ Î£) â†’ âˆˆâ‚› (Ïƒ â‚‘âˆ˜â‚› Î´) v â‰¡ âˆˆâ‚› Î´ (âˆˆâ‚‘ Ïƒ v)
âˆˆ-â‚‘âˆ˜â‚› âˆ™        Î´       v      = refl
âˆˆ-â‚‘âˆ˜â‚› (drop Ïƒ) (Î´ , t) v      = âˆˆ-â‚‘âˆ˜â‚› Ïƒ Î´ v
âˆˆ-â‚‘âˆ˜â‚› (keep Ïƒ) (Î´ , t) vz     = refl
âˆˆ-â‚‘âˆ˜â‚› (keep Ïƒ) (Î´ , t) (vs v) = âˆˆ-â‚‘âˆ˜â‚› Ïƒ Î´ v

Tm-â‚‘âˆ˜â‚› : âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î£)(Î´ : Sub Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚› (Ïƒ â‚‘âˆ˜â‚› Î´) t â‰¡ Tmâ‚› Î´ (Tmâ‚‘ Ïƒ t)
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (if t u v) = if & Tm-â‚‘âˆ˜â‚› Ïƒ Î´ t âŠ— Tm-â‚‘âˆ˜â‚› Ïƒ Î´ u âŠ— Tm-â‚‘âˆ˜â‚› Ïƒ Î´ v
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ false      = refl
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ true       = refl
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (var v) = âˆˆ-â‚‘âˆ˜â‚› Ïƒ Î´ v
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (lam t) =
  lam & ((Î» x â†’ Tmâ‚› (x , var vz) t) & assâ‚‘â‚›â‚‘ Ïƒ Î´ wk â—¾ Tm-â‚‘âˆ˜â‚› (keep Ïƒ) (keepâ‚› Î´) t)
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (app f a) = app & Tm-â‚‘âˆ˜â‚› Ïƒ Î´ f âŠ— Tm-â‚‘âˆ˜â‚› Ïƒ Î´ a

âˆˆ-â‚›âˆ˜â‚‘ : âˆ€ {A Î“ Î” Î£}(Ïƒ : Sub Î” Î£)(Î´ : OPE Î“ Î”)(v : A âˆˆ Î£) â†’ âˆˆâ‚› (Ïƒ â‚›âˆ˜â‚‘ Î´) v â‰¡ Tmâ‚‘ Î´ (âˆˆâ‚› Ïƒ v)
âˆˆ-â‚›âˆ˜â‚‘ (Ïƒ , _) Î´ vz     = refl
âˆˆ-â‚›âˆ˜â‚‘ (Ïƒ , _) Î´ (vs v) = âˆˆ-â‚›âˆ˜â‚‘ Ïƒ Î´ v

Tm-â‚›âˆ˜â‚‘ : âˆ€ {A Î“ Î” Î£}(Ïƒ : Sub Î” Î£)(Î´ : OPE Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚› (Ïƒ â‚›âˆ˜â‚‘ Î´) t â‰¡ Tmâ‚‘ Î´ (Tmâ‚› Ïƒ t)
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (if t u v) = if & Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ t âŠ— Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ u âŠ— Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ v
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ false      = refl
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ true       = refl
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (var v)   = âˆˆ-â‚›âˆ˜â‚‘ Ïƒ Î´ v
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (lam t)   =
  lam &
      ((Î» x â†’ Tmâ‚› (x , var vz) t) &
          (assâ‚›â‚‘â‚‘ Ïƒ Î´ wk
        â—¾ (Ïƒ â‚›âˆ˜â‚‘_) & (drop & (idrâ‚‘ Î´ â—¾ idlâ‚‘ Î´ â»Â¹))
        â—¾ assâ‚›â‚‘â‚‘ Ïƒ wk (keep Î´) â»Â¹)
    â—¾ Tm-â‚›âˆ˜â‚‘ (keepâ‚› Ïƒ) (keep Î´) t)
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (app f a) = app & Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ f âŠ— Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ a

assâ‚›â‚‘â‚› :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : OPE Î” Î£)(Î½ : Sub Î“ Î”)
  â†’ (Ïƒ â‚›âˆ˜â‚‘ Î´) âˆ˜â‚› Î½ â‰¡ Ïƒ âˆ˜â‚› (Î´ â‚‘âˆ˜â‚› Î½)
assâ‚›â‚‘â‚› âˆ™       Î´ Î½ = refl
assâ‚›â‚‘â‚› (Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚‘â‚› Ïƒ Î´ Î½ âŠ— (Tm-â‚‘âˆ˜â‚› Î´ Î½ t â»Â¹)

assâ‚›â‚›â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : Sub Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ âˆ˜â‚› Î´) â‚›âˆ˜â‚‘ Î½ â‰¡ Ïƒ âˆ˜â‚› (Î´ â‚›âˆ˜â‚‘ Î½)
assâ‚›â‚›â‚‘ âˆ™       Î´ Î½ = refl
assâ‚›â‚›â‚‘ (Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚›â‚‘ Ïƒ Î´ Î½ âŠ— (Tm-â‚›âˆ˜â‚‘ Î´ Î½ t â»Â¹)

âˆˆ-idâ‚› : âˆ€ {A Î“}(v : A âˆˆ Î“) â†’ âˆˆâ‚› idâ‚› v â‰¡ var v
âˆˆ-idâ‚› vz     = refl
âˆˆ-idâ‚› (vs v) = âˆˆ-â‚›âˆ˜â‚‘ idâ‚› wk v â—¾ Tmâ‚‘ wk & âˆˆ-idâ‚› v â—¾ (var âˆ˜ vs) & âˆˆ-idâ‚‘ v

âˆˆ-âˆ˜â‚› : âˆ€ {A Î“ Î” Î£}(Ïƒ : Sub Î” Î£)(Î´ : Sub Î“ Î”)(v : A âˆˆ Î£) â†’ âˆˆâ‚› (Ïƒ âˆ˜â‚› Î´) v â‰¡ Tmâ‚› Î´ (âˆˆâ‚› Ïƒ v)
âˆˆ-âˆ˜â‚› (Ïƒ , _) Î´ vz     = refl
âˆˆ-âˆ˜â‚› (Ïƒ , _) Î´ (vs v) = âˆˆ-âˆ˜â‚› Ïƒ Î´ v

Tm-idâ‚› : âˆ€ {A Î“}(t : Tm Î“ A) â†’ Tmâ‚› idâ‚› t â‰¡ t
Tm-idâ‚› (if t u v) = if & Tm-idâ‚› t âŠ— Tm-idâ‚› u âŠ— Tm-idâ‚› v
Tm-idâ‚› false      = refl
Tm-idâ‚› true       = refl
Tm-idâ‚› (var v)   = âˆˆ-idâ‚› v
Tm-idâ‚› (lam t)   = lam & Tm-idâ‚› t
Tm-idâ‚› (app f a) = app & Tm-idâ‚› f âŠ— Tm-idâ‚› a

Tm-âˆ˜â‚› : âˆ€ {A Î“ Î” Î£}(Ïƒ : Sub Î” Î£)(Î´ : Sub Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚› (Ïƒ âˆ˜â‚› Î´) t â‰¡ Tmâ‚› Î´ (Tmâ‚› Ïƒ t)
Tm-âˆ˜â‚› Ïƒ Î´ (if t u v) = if & Tm-âˆ˜â‚› Ïƒ Î´ t âŠ— Tm-âˆ˜â‚› Ïƒ Î´ u âŠ— Tm-âˆ˜â‚› Ïƒ Î´ v
Tm-âˆ˜â‚› Ïƒ Î´ false      = refl
Tm-âˆ˜â‚› Ïƒ Î´ true       = refl
Tm-âˆ˜â‚› Ïƒ Î´ (var v)   = âˆˆ-âˆ˜â‚› Ïƒ Î´ v
Tm-âˆ˜â‚› Ïƒ Î´ (lam t)   =
  lam &
      ((Î» x â†’ Tmâ‚› (x , var vz) t) &
          (assâ‚›â‚›â‚‘ Ïƒ Î´ wk
        â—¾ (Ïƒ âˆ˜â‚›_) & (idlâ‚‘â‚›  (dropâ‚› Î´) â»Â¹) â—¾ assâ‚›â‚‘â‚› Ïƒ wk (keepâ‚› Î´) â»Â¹)
    â—¾ Tm-âˆ˜â‚› (keepâ‚› Ïƒ) (keepâ‚› Î´) t)
Tm-âˆ˜â‚› Ïƒ Î´ (app f a) = app & Tm-âˆ˜â‚› Ïƒ Î´ f âŠ— Tm-âˆ˜â‚› Ïƒ Î´ a

idrâ‚› : âˆ€ {Î“ Î”}(Ïƒ : Sub Î“ Î”) â†’ Ïƒ âˆ˜â‚› idâ‚› â‰¡ Ïƒ
idrâ‚› âˆ™       = refl
idrâ‚› (Ïƒ , t) = _,_ & idrâ‚› Ïƒ âŠ— Tm-idâ‚› t

idlâ‚› : âˆ€ {Î“ Î”}(Ïƒ : Sub Î“ Î”) â†’ idâ‚› âˆ˜â‚› Ïƒ â‰¡ Ïƒ
idlâ‚› âˆ™       = refl
idlâ‚› (Ïƒ , t) = (_, t) & (assâ‚›â‚‘â‚› idâ‚› wk (Ïƒ , t) â—¾ (idâ‚› âˆ˜â‚›_) & idlâ‚‘â‚› Ïƒ â—¾ idlâ‚› Ïƒ)

-- Conversion
--------------------------------------------------------------------------------

data _~_ {Î“} : âˆ€ {A} â†’ Tm Î“ A â†’ Tm Î“ A â†’ Set where
  Î²     : âˆ€ {A B}(t : Tm (Î“ â–¶ A) B) t'  â†’ app (lam t) t' ~ Tmâ‚› (idâ‚› , t') t
  Î·     : âˆ€ {A B}(t : Tm Î“ (A â‡’ B))     â†’ t ~ lam (app (Tmâ‚‘ wk t) (var vz))
  lam   : âˆ€ {A B}{t t' : Tm (Î“ â–¶ A) B}  â†’ t ~ t' â†’  lam t ~ lam t'
  app   : âˆ€ {A B}{t t' : Tm Î“ (A â‡’ B)}{u u'} â†’ t ~ t' â†’ u ~ u' â†’ app t u ~ app t' u'
  true  : âˆ€ {A}{t u : Tm Î“ A} â†’ if true  t u ~ t
  false : âˆ€ {A}{t u : Tm Î“ A} â†’ if false t u ~ u
  if    : âˆ€ {A}{t t' : Tm Î“ ğ”¹}{u u' v v' : Tm Î“ A} â†’ t ~ t' â†’ u ~ u' â†’ v ~ v' â†’ if t u v ~ if t' u' v'
  ~refl : âˆ€ {A}{t : Tm Î“ A} â†’ t ~ t
  _~â»Â¹  : âˆ€ {A}{t t' : Tm Î“ A} â†’ t ~ t' â†’ t' ~ t
  _~â—¾_  : âˆ€ {A}{t t' t'' : Tm Î“ A} â†’ t ~ t' â†’ t' ~ t'' â†’ t ~ t''

~â‚‘ : âˆ€ {Î“ Î” A}{t t' : Tm Î“ A}(Ïƒ : OPE Î” Î“) â†’ t ~ t' â†’ Tmâ‚‘ Ïƒ t ~ Tmâ‚‘ Ïƒ t'
~â‚‘ Ïƒ (Î· t) =
  coe ((Î» t' â†’ Tmâ‚‘ Ïƒ t ~ lam (app t' (var vz)))
    & (Tm-âˆ˜â‚‘ Ïƒ wk t â»Â¹
    â—¾ (Î» x â†’ Tmâ‚‘ (drop x) t) & (idrâ‚‘ Ïƒ â—¾ idlâ‚‘ Ïƒ â»Â¹)
    â—¾ Tm-âˆ˜â‚‘ wk  (keep Ïƒ) t))
  (Î· (Tmâ‚‘ Ïƒ t))

~â‚‘ Ïƒ (Î² t t') =
  coe ((app (lam (Tmâ‚‘ (keep Ïƒ) t)) (Tmâ‚‘ Ïƒ t') ~_) &
    (Tm-â‚‘âˆ˜â‚› (keep Ïƒ) (idâ‚› , Tmâ‚‘ Ïƒ t') t â»Â¹
    â—¾ (Î» x â†’ Tmâ‚› (x , Tmâ‚‘ Ïƒ t') t) & (idrâ‚‘â‚› Ïƒ â—¾ idlâ‚›â‚‘ Ïƒ â»Â¹)
    â—¾ Tm-â‚›âˆ˜â‚‘ (idâ‚› , t') Ïƒ t))
  (Î² (Tmâ‚‘ (keep Ïƒ) t) (Tmâ‚‘ Ïƒ t'))

~â‚‘ Ïƒ (lam t~t')       = lam (~â‚‘ (keep Ïƒ) t~t')
~â‚‘ Ïƒ (app t~t' x~x')  = app (~â‚‘ Ïƒ t~t') (~â‚‘ Ïƒ x~x')
~â‚‘ Ïƒ ~refl            = ~refl
~â‚‘ Ïƒ (t~t' ~â»Â¹)       = ~â‚‘ Ïƒ t~t' ~â»Â¹
~â‚‘ Ïƒ (t~t' ~â—¾ t'~t'') = ~â‚‘ Ïƒ t~t' ~â—¾ ~â‚‘ Ïƒ t'~t''
~â‚‘ Ïƒ true             = true
~â‚‘ Ïƒ false            = false
~â‚‘ Ïƒ (if t u v)       = if (~â‚‘ Ïƒ t) (~â‚‘ Ïƒ u) (~â‚‘ Ïƒ v)
